<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phase Classification</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
      background: #f5f5f5;
    }

    img {
      max-width: 300px;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 18px;
      margin-top: 15px;
      font-size: 16px;
      cursor: pointer;
    }

    .results {
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <h2>Phase Classification</h2>

  <!-- Upload / Camera -->
  <input type="file" id="imageUpload" accept="image/*" capture="environment" />

  <br />
  <img id="preview" crossorigin="anonymous" />

  <br />
  <button onclick="classifyImage()">Begin Classify</button>

  <div class="results" id="results"></div>

  <script>
    // ðŸ”´ IMPORTANT: CHANGE THIS TO YOUR REAL URL
    const MODEL_URL =
      "https://github.com/jan0611-code/TugasAkhir2/releases/tag/v2.0/model.json";

    // âš ï¸ MUST MATCH TRAINING ORDER
    const CLASS_NAMES = ["WD", "FWD", "GP"];

    let model;
    let imageElement = document.getElementById("preview");
    let imageReady = false;

    // Load model
    async function loadModel() {
      document.getElementById("results").innerText = "Loading model...";
      model = await tf.loadLayersModel(MODEL_URL);
      console.log("MODEL LOADED");
      document.getElementById("results").innerText = "Model loaded âœ…";
    }
    loadModel();

    // Handle image upload
    document.getElementById("imageUpload").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      imageReady = false;

      const reader = new FileReader();
      reader.onload = () => {
        imageElement.onload = () => {
          imageReady = true;
        };
        imageElement.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    async function classifyImage() {
      if (!model) {
        alert("Model not loaded yet");
        return;
      }

      if (!imageReady) {
        alert("Image still loading, please wait");
        return;
      }

      // Preprocess (MATCH TRAINING INPUT)
      const tensor = tf.browser
        .fromPixels(imageElement)
        .resizeNearestNeighbor([224, 224])
        .toFloat()
        .div(255.0)
        .expandDims(0);

      const predictions = model.predict(tensor);
      const data = await predictions.data();

      let output = "<h3>Prediction Result</h3>";
      let maxIndex = data.indexOf(Math.max(...data));

      CLASS_NAMES.forEach((name, i) => {
        output += `${name}: ${(data[i] * 100).toFixed(2)}%<br/>`;
      });

      output += `<br/><b>Predicted Phase: ${CLASS_NAMES[maxIndex]}</b>`;

      document.getElementById("results").innerHTML = output;

      tf.dispose(tensor);
      tf.dispose(predictions);
    }
  </script>

</body>
</html>
